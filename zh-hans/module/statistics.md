# 统计功能
## 简介
统计功能是，对热钱包里所有已开启的代币，定时对数据库里**未被统计的**且已经是**最终状态**的订单进行金额、笔数、矿工费等的数据统计。统计完成后可向前置系统发送回调通知，也可在Admin界面上下载每天的数据统计报表。

## 术语和概念
### 统计截止时间
需要统计的订单的截止时间。例如：如果统计截止时间是北京时间0点，那么统计只会计算打包在这一天0点以前区块的交易所对应的订单。统计截止时间目前在系统里不可修改，截止时间是所选择时区的0点。

### 统计时区时区
发起统计时筛选订单的统计截止时间是该时区的0点。例如，如果时区选择+8，则是北京时间，那么统计截止时间是北京时间每日0点。
配置所在Admin界面位置：“高级管理”->“系统配置”->“参数配置”

### 统计发起时间
部署Jadepool Hub系统所在的服务器发起统计的时间，应该设置为服务器所在时区的欲发起统计时间。例如：部署系统的服务器在北京，设置“每日统计时间”为08:00，时区设置为+8，那么就是每日的北京时间早8点发起对0点之前订单的统计。
配置所在Admin界面位置：在“高级管理”->“系统配置”->“功能”

### 订单最终状态
订单最终状态是指“完成”和“失败”。只有达到最终状态的订单才会被统计。

### 订单统计状态
订单被统计后会被标识已被统计，每次统计一定是针对在统计截止区块前所有未被标识统计的订单。

## 功能原理
首先，对于每个已开启的代币所对应的区块链，统计截止时间可以在Jadepool Hub数据库里找到的最近的区块号，即统计截止区块。例如：如果统计截止时间戳是1588081381000，数据库中记录BTC有一个区块号为100的产块时间是1588081380000，是在统计截止时间戳前产生时间最晚的区块，那么这一天的统计截止区块就是100。

然后，找出所有区块号在统计截止区块前的所有**未被统计的**的状态是“完成”的订单。同时，找出所有订单创建时间在统计截止时间之前的状态是“失败”订单。因为只有状态是“完成”的订单有区块号，“失败”的订单没有区块号，所以需要以订单创建时间筛选失败订单。

因为每次统计的订单对象都是截止区块之前的**未被统计的**订单，且Jadepool Hub每日都会自动统计，则每次统计的应该是前一统计天到此次统计天之间发生的所有订单。但存在以下特殊情况。
**特殊情况**：如果统计截止区块是100，有一笔订单交易被打包在99，但发起统计的时候，这笔订单还没达到最终状态，那该笔订单将会被包含在下次统计。

因为不能控制统计起始时间，只能定义截止时间。如果“自动统计功能”一直处在关闭状态，那么再次开启会统计到之前的所有订单，并被记在当前统计天。

## 具体使用
### 下载报表
下载统计报表步骤：
1. 登陆Admin，进入热钱包
2. 进入“统计”页面
3. 选择欲下载报表的日期，如果该日期有进行过统计，则可以点击“下载统计报表”按钮
4. 统计报表会以zip包的形式被下载，进行解压，关于报表详解请继续往下阅读

**注意**：目前，对于已被禁用的代币，即使启用当时被统计过，但禁用后点击当时统计日期，统计结果不会显示在界面上或下载的统计报表里。后续版本会优化。

#### fee.csv

对于所有被统计的代币，该报表会展示每一个代币在该统计天各种不同订单类型所消耗的的手续费。以下表格说明中的xx代表某订单类型，对订单类型的更多详细解释请参考[产品术语](术语/jade-terms.html)。

报表表头   | 定义
--------- | ------- 
交易币种  | 被统计的代币
矿工费币种  | 被统计代币的交易所消耗的矿工费币种，例如所有ERC20消耗的矿工费是ETH 
xx成功矿工费  | 某订单类型的成功订单消耗的矿工费合计 
xx成功笔数  | 某订单类型的成功订单笔数 
xx成功平均矿工费  | xx成功矿工费/xx成功笔数，同一订单类型的成功订单的消耗矿工费平均值 
xx失败矿工费  | 某订单类型的失败订单消耗的矿工费合计。如ERC20有可能出现交易上链成功，消耗了ETH但智能合约执行失败而导致转账失败 
xx失败笔数  | 某订单类型的失败订单笔数 
xx失败平均矿工费  | xx失败矿工费/xx失败笔数，同一订单类型的失败订单的消耗矿工费平均值 

#### internal.csv
对于所有被统计的代币，该报表会展示每一个代币在该统计天各种不同内部资金流转的订单类型的总金额和笔数。以下表格说明中的xx代表某订单类型，对订单类型的更多详细解释请参考[产品术语](术语/jade-terms.html)。

报表表头   | 定义 
----  | ---- 
交易币种  | 被统计的代币
xx金额  | 某内部订单类型的总金额
xx笔数  | 某内部订单类型的总笔数

#### orders.csv
该报表会展示该统计天被统计的所有订单的核心信息。

#### summary.csv
报表表头   | 定义 
----  | ---- 
交易币种  | 被统计的代币
区块ID  | 此次统计的统计截止区块
审计日期  | 此次统计的对应日期
每日业务金额  | 此次统计天的净流水，即所有入账和所有出账之差
每日交易费用  | 此次统计天的消耗矿工费总额
累计业务金额  | 累计净流水，即历史所有入账和所有出账之差
累计交易费用  | 历史所有订单消耗矿工费总额
热钱包余额  | 用历史上所有订单计算出的热钱包余额理论值，不能代表链上真实余额

### 接收回调
如果在热钱包设置统计的回调接收服务地址，Jadepool Hub每日自动统计完成后，会针对每个被统计的代币向前置系统推送统计结果。
回调统计示例请参考：*https://nbltrust.github.io/jadepool-hub-api-docs/#audit-3*

**注意**：统计回调通知中的所有信息都是上一统计天到此次统计天的统计差值，不是历史累计值。

设置统计回调接收服务地址步骤：
1. 登陆Admin，进入热钱包
2. 进入“设置”->“应用”页面
3. 选择应用，在右侧填写“统计通知地址”

**注意**：统计功能是针对钱包，而不是针对某应用，所以只要在任意应用里配置了“统计通知地址”就可以接收到针对整个钱包的统计结果。


